<!doctype html>
const labelRenderer = new THREE.CSS2DRenderer();
labelRenderer.setSize(window.innerWidth, window.innerHeight);
labelRenderer.domElement.style.position = 'absolute';
labelRenderer.domElement.style.top = '0px';
container.appendChild(labelRenderer.domElement);


const controls = new THREE.OrbitControls(camera, labelRenderer.domElement);
controls.enableDamping = true;


// --- Cenário estilo boate ---
const floor = new THREE.Mesh(new THREE.BoxGeometry(20,0.1,20), new THREE.MeshStandardMaterial({color:0x111111, metalness:0.3, roughness:0.7})); scene.add(floor);
const stage = new THREE.Mesh(new THREE.BoxGeometry(6,0.6,4), new THREE.MeshStandardMaterial({color:0x222222, metalness:0.5, roughness:0.4})); stage.position.set(0,0.3,-5); scene.add(stage);
const speakerGeo = new THREE.BoxGeometry(0.5,1.2,0.5);
const speakerMat = new THREE.MeshStandardMaterial({color:0x333333, metalness:0.5, roughness:0.3});
const leftSpeaker = new THREE.Mesh(speakerGeo, speakerMat); leftSpeaker.position.set(-3,0.6,-4.5); scene.add(leftSpeaker);
const rightSpeaker = new THREE.Mesh(speakerGeo, speakerMat); rightSpeaker.position.set(3,0.6,-4.5); scene.add(rightSpeaker);
const ledColors = [0xff0040,0x00ff80,0x0040ff,0xffff00];
const leds = [];
for(let i=0;i<8;i++){ const l=new THREE.PointLight(ledColors[i%ledColors.length],1,15); l.position.set(Math.sin(i/8*Math.PI*2)*6,2,Math.cos(i/8*Math.PI*2)*6); scene.add(l); leds.push(l); }
const disco = new THREE.Mesh(new THREE.SphereGeometry(0.7,24,24), new THREE.MeshStandardMaterial({color:0xffffff, metalness:1, roughness:0.2})); disco.position.set(0,3.5,0); scene.add(disco);


const avatars = {};
const audio = new Audio(); audio.crossOrigin='anonymous'; audio.loop=false; audio.preload='auto'; let audioContext, sourceNode, analyser;
function setupAudioNodes(){ if(audioContext) return; audioContext=new (window.AudioContext||window.webkitAudioContext)(); sourceNode=audioContext.createMediaElementSource(audio); analyser=audioContext.createAnalyser(); analyser.fftSize=256; sourceNode.connect(analyser); analyser.connect(audioContext.destination); }
const eqGroup=new THREE.Group(); scene.add(eqGroup); const eqCount=24; const eqGeo=new THREE.BoxGeometry(0.25,1,0.25); for(let i=0;i<eqCount;i++){ const m=new THREE.Mesh(eqGeo,new THREE.MeshStandardMaterial({color:0xff66ff})); m.position.x=(i-eqCount/2)*0.28; m.position.y=0.3; eqGroup.add(m); } eqGroup.position.set(0,0.6,-5);


const $room=document.getElementById('room');
const $isHost=document.getElementById('isHost');
const $peeps=document.getElementById('peeps');
let channel;
function joinChannel(){ const roomName='raveroom|'+$room.value; if(channel) channel.close(); channel=new BroadcastChannel(roomName); channel.onmessage=(ev)=>handleMessage(ev.data); send({type:'presence',nick:$nick.value,color:$color.value}); }
function send(obj){ if(!channel) joinChannel(); obj.nick=$nick.value; channel.postMessage(obj); }
function handleMessage(msg){ if(msg.type==='presence'){ addPeer(msg.nick,msg.color); } }
function addPeer(name,color){ if(avatars[name]) return; const mat=new THREE.MeshStandardMaterial({color:new THREE.Color(color)}); const sphere=new THREE.Mesh(new THREE.SphereGeometry(0.5,16,16),mat); const x=(Object.keys(avatars).length%8)-4; const z=Math.floor(Object.keys(avatars).length/8)*-1-1; sphere.position.set(x,0.6,z); scene.add(sphere); const div=document.createElement('div'); div.className='label'; div.textContent=name; div.style.padding='4px 8px'; div.style.background='rgba(0,0,0,0.5)'; const label=new THREE.CSS2DObject(div); label.position.set(0,0.8,0); sphere.add(label); avatars[name]={mesh:sphere,label:div}; refreshPeepsUI(); }
function refreshPeepsUI(){ $peeps.innerHTML=''; for(const n of Object.keys(avatars)){ const el=document.createElement('span'); el.className='pill'; el.textContent=n; $peeps.appendChild(el); } }


const welcomeScreen=document.getElementById('welcome-screen');
const enterBtn=document.getElementById('enter-btn');
const welcomeNick=document.getElementById('welcome-nick');
const welcomeColor=document.getElementById('welcome-color');
const welcomeRole=document.getElementById('welcome-role');
const $nick={value:'Host'}; const $color={value:'#ff3b3b'};
let role='clubber';


enterBtn.onclick=()=>{
$nick.value=welcomeNick.value.trim()||'Convidado';
$color.value=welcomeColor.value;
role=welcomeRole.value;
addPeer($nick.value,$color.value);
welcomeScreen.style.display='none';
document.getElementById('ui').style.display='block';
joinChannel();


// Cria AudioContext apenas após clique
if(role==='dj'){ setupAudioNodes(); }
};


const freqData=new Uint8Array(128);
function animate(t){ requestAnimationFrame(animate); disco.rotation.y+=0.01; for(let i=0;i<leds.length;i++){ const a=t/1000+i*0.9; leds[i].intensity=0.8+Math.sin(a*2)*0.6; leds[i].color.setHSL((t/1000*0.1+i*0.1)%1,0.8,0.5); leds[i].position.y=1.5+Math.sin(a*1.3)*0.5; } if(analyser){ analyser.getByteFrequencyData(freqData); for(let i=0;i<eqCount;i++){ const v=freqData[i*2]/255; eqGroup.children[i].scale.y=0.2+v*6; eqGroup.children[i].position.y=0.3+eqGroup.children[i].scale.y/2; } } controls.update(); renderer.render(scene,camera); labelRenderer.render(scene,camera); }
animate();
window.addEventListener('resize',()=>{ camera.aspect=window.innerWidth/window.innerHeight; camera.updateProjectionMatrix(); renderer.setSize(window.innerWidth,window.innerHeight); labelRenderer.setSize(window.innerWidth,window.innerHeight); });
});
</script>
</body>
</html>
