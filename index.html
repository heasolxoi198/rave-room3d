<!doctype html>
<html lang="pt-BR">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>RaveRoom3D — Protótipo</title>
  <style>
    html,body{height:100%;margin:0;font-family:Inter,system-ui,Arial;background:#0a0a0a;color:#eee}
    #ui{position:fixed;left:12px;top:12px;z-index:20;width:320px;background:rgba(0,0,0,0.5);padding:12px;border-radius:10px}
    label{display:block;font-size:13px;margin-top:8px}
    input,select,button{width:100%;padding:8px;margin-top:6px;border-radius:6px;border:1px solid rgba(255,255,255,0.08);background:rgba(255,255,255,0.02);color:#fff}
    #canvas-container{width:100%;height:100%}
    .player-controls{display:flex;gap:8px;margin-top:8px}
    .small{padding:6px;font-size:13px}
    #peeps{margin-top:8px;display:flex;gap:8px;flex-wrap:wrap}
    .pill{background:rgba(255,255,255,0.06);padding:6px 8px;border-radius:999px;font-size:13px}
    #help{font-size:12px;opacity:0.8;margin-top:8px}
  </style>
</head>
<body>
  <div id="ui">
    <strong>RaveRoom3D — Protótipo</strong>
    <label>Nome da sala (qualquer):<input id="room" value="minha-rave"/></label>
    <label>Seu nome:<input id="nick" value="Host"/></label>
    <label>Avatar (cor):<input id="color" type="color" value="#ff3b3b"/></label>

    <label>Fonte de áudio (URL ou deixar vazio para carregar arquivo):<input id="audioUrl" placeholder="https://.../musica.mp3"/></label>
    <input id="file" type="file" accept="audio/*"/>

    <div class="player-controls">
      <button id="play" class="small">Play/Pause</button>
      <button id="seekBack" class="small">-5s</button>
      <button id="seekFwd" class="small">+5s</button>
    </div>

    <label>Você é host? (quem controla a reprodução):
      <select id="isHost"><option value="true">Sim (Host)</option><option value="false">Não (Convidado)</option></select>
    </label>

    <div id="peeps"></div>
    <div id="help">Abra este arquivo em várias abas do mesmo navegador para testar (BroadcastChannel). Para convidar amigos pela internet use a backend (ex: Firebase) — instruções abaixo.</div>
  </div>

  <div id="canvas-container"></div>

  <!-- three.js and helpers -->
  <script src="https://cdn.jsdelivr.net/npm/three@0.157.0/build/three.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/three@0.157.0/examples/js/controls/OrbitControls.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/three@0.157.0/examples/js/renderers/CSS2DRenderer.js"></script>

  <script>
  document.addEventListener('DOMContentLoaded',()=>{
  const container = document.getElementById('canvas-container');
  const scene = new THREE.Scene();
  const camera = new THREE.PerspectiveCamera(60, window.innerWidth/window.innerHeight, 0.1, 1000);
  camera.position.set(0,6,12);
  const renderer = new THREE.WebGLRenderer({antialias:true});
  renderer.setSize(window.innerWidth, window.innerHeight);
  renderer.setClearColor(0x05050a);
  container.appendChild(renderer.domElement);

  const labelRenderer = new THREE.CSS2DRenderer();
  labelRenderer.setSize(window.innerWidth, window.innerHeight);
  labelRenderer.domElement.style.position = 'absolute';
  labelRenderer.domElement.style.top = '0px';
  container.appendChild(labelRenderer.domElement);

  const controls = new THREE.OrbitControls(camera, labelRenderer.domElement);
  controls.enableDamping = true;

  // floor
  const floor = new THREE.Mesh(new THREE.CircleGeometry(12,64), new THREE.MeshStandardMaterial({color:0x111111,metalness:0.3,roughness:0.6}));
  floor.rotation.x = -Math.PI/2; scene.add(floor);

  // stage
  const stage = new THREE.Mesh(new THREE.CylinderGeometry(3.5,3.5,0.6,32), new THREE.MeshStandardMaterial({color:0x222222,metalness:0.5,roughness:0.4}));
  stage.position.y = 0.3; scene.add(stage);

  // disco ball
  const disco = new THREE.Mesh(new THREE.SphereGeometry(1.2,24,24), new THREE.MeshStandardMaterial({color:0xffffff, metalness:1, roughness:0.2}));
  disco.position.set(0,4,0); scene.add(disco);

  // lights
  const amb = new THREE.AmbientLight(0xffffff,0.12); scene.add(amb);
  const pointL = new THREE.PointLight(0xff0040,1,30); pointL.position.set(5,6,5); scene.add(pointL);
  const pointR = new THREE.PointLight(0x0040ff,1,30); pointR.position.set(-5,6,5); scene.add(pointR);

  const lights = [];
  for(let i=0;i<6;i++){ const l = new THREE.PointLight(0xffffff,1,20); scene.add(l); lights.push(l); }

  const avatars = {};

  const audio = new Audio(); audio.crossOrigin='anonymous'; audio.loop=false; audio.preload='auto';
  let audioContext, sourceNode, analyser;
  function setupAudioNodes(){
    if(audioContext) return;
    audioContext = new (window.AudioContext||window.webkitAudioContext)();
    sourceNode = audioContext.createMediaElementSource(audio);
    analyser = audioContext.createAnalyser();
    analyser.fftSize=256;
    sourceNode.connect(analyser);
    analyser.connect(audioContext.destination);
  }

  const eqGroup = new THREE.Group(); scene.add(eqGroup);
  const eqCount = 24; const eqGeo = new THREE.BoxGeometry(0.25,1,0.25);
  for(let i=0;i<eqCount;i++){ const m=new THREE.Mesh(eqGeo,new THREE.MeshStandardMaterial({color:0xff66ff})); m.position.x=(i-eqCount/2)*0.28; m.position.y=0.3; eqGroup.add(m); }
  eqGroup.position.y=0.6;

  const $room = document.getElementById('room');
  const $nick = document.getElementById('nick');
  const $color = document.getElementById('color');
  const $play = document.getElementById('play');
  const $seekBack = document.getElementById('seekBack');
  const $seekFwd = document.getElementById('seekFwd');
  const $peeps = document.getElementById('peeps');
  const $audioUrl = document.getElementById('audioUrl');
  const $file = document.getElementById('file');
  const $isHost = document.getElementById('isHost');

  let channel;
  function joinChannel(){
    const roomName='raveroom|'+$room.value;
    if(channel) channel.close();
    channel = new BroadcastChannel(roomName);
    channel.onmessage=(ev)=>handleMessage(ev.data);
    send({type:'presence',nick:$nick.value,color:$color.value});
    if($isHost.value==='false') send({type:'request_state',nick:$nick.value});
  }

  function send(obj){ if(!channel) joinChannel(); obj.nick=$nick.value; channel.postMessage(obj); }

  function handleMessage(msg){
    if(msg.type==='presence'){ addPeer(msg.nick,msg.color); }
    else if(msg.type==='announce_state'){ if($isHost.value==='false'&&msg.state) applyState(msg.state); }
    else if(msg.type==='state'){ if($isHost.value==='false'){ if(msg.action==='play') setPositionAndPlay(msg.time); else if(msg.action==='pause'){ audio.pause(); audio.currentTime=msg.time||0; } else if(msg.action==='seek') audio.currentTime=msg.time||0; } }
    else if(msg.type==='request_state'){ if($isHost.value==='true') send({type:'announce_state',state:buildState()}); }
  }

  function buildState(){ return {src:audio.src||null,playing:!audio.paused&&!audio.ended,time:audio.currentTime}; }
  function applyState(state){ if(!state) return; if(state.src&&!audio.src){ audio.src=state.src; } audio.currentTime=state.time||0; if(state.playing) audioContext.resume().then(()=>audio.play().catch(()=>{})); }

  function addPeer(name,color){ if(avatars[name]) return; const mat=new THREE.MeshStandardMaterial({color:new THREE.Color(color)}); const sphere=new THREE.Mesh(new THREE.SphereGeometry(0.5,16,16),mat); const x=(Object.keys(avatars).length%8)-4; const z=Math.floor(Object.keys(avatars).length/8)*-1-1; sphere.position.set(x,0.6,z); scene.add(sphere); const div=document.createElement('div'); div.className='label'; div.textContent=name; div.style.padding='4px 8px'; div.style.background='rgba(0,0,0,0.5)'; const label=new THREE.CSS2DObject(div); label.position.set(0,0.8,0); sphere.add(label); avatars[name]={mesh:sphere,label:div}; refreshPeepsUI(); }

  function refreshPeepsUI(){ $peeps.innerHTML=''; for(const n of Object.keys(avatars)){ const el=document.createElement('span'); el.className='pill'; el.textContent=n; $peeps.appendChild(el); } }

  function hostPlayPause(){
    setupAudioNodes();
    audioContext.resume().then(()=>{
      if(audio.paused){ audio.play().then(()=>{ send({type:'state',action:'play',time:audio.currentTime}); }).catch(()=>{}); }
      else{ audio.pause(); send({type:'state',action:'pause',time:audio.currentTime}); }
    });
  }

  $play.onclick = ()=>{
    setupAudioNodes();
    audioContext.resume().then(()=>{
      if($isHost.value==='true') hostPlayPause();
      else{ if(audio.paused) audio.play().catch(()=>{}); else audio.pause(); }
    });
  };

  $seekBack.onclick=()=>{ audio.currentTime=Math.max(0,audio.currentTime-5); if($isHost.value==='true') send({type:'state',action:'seek',time:audio.currentTime}); };
  $seekFwd.onclick=()=>{ audio.currentTime=Math.min(audio.duration||9999,audio.currentTime+5); if($isHost.value==='true') send({type:'state',action:'seek',time:audio.currentTime}); };

  $audioUrl.onchange=()=>{ if($audioUrl.value){ audio.src=$audioUrl.value; setupAudioNodes(); audioContext.resume().then(()=>{ if($isHost.value==='true') send({type:'announce_state',state:buildState()}); }); } };
  $file.onchange=(e)=>{ const f=e.target.files[0]; if(!f) return; audio.src=URL.createObjectURL(f); setupAudioNodes(); audioContext.resume().then(()=>{ if($isHost.value==='true') send({type:'announce_state',state:buildState()}); }); };

  $room.onchange=()=>joinChannel(); $nick.onchange=()=>send({type:'presence',nick:$nick.value,color:$color.value}); $color.onchange=()=>send({type:'presence',nick:$nick.value,color:$color.value}); $isHost.onchange=()=>{ if($isHost.value==='true') send({type:'presence',nick:$nick.value,color:$color.value}); };

  function setPositionAndPlay(t){ setupAudioNodes(); audioContext.resume().then(()=>{ audio.currentTime=t||0; audio.play().catch(()=>{}); }); }

  const freqData = new Uint8Array(128);
  function animate(t){ requestAnimationFrame(animate); disco.rotation.y+=0.01; for(let i=0;i<lights.length;i++){ const a=t/1000+i*0.9; lights[i].position.set(Math.cos(a)*6,2+Math.sin(a*1.3)*1.5,Math.sin(a)*6); lights[i].intensity=0.8+Math.sin(a*2)*0.6; lights[i].color.setHSL((t/1000*0.08+i*0.1)%1,0.8,0.5); }
  if(analyser){ analyser.getByteFrequencyData(freqData); for(let i=0;i<eqCount;i++){ const v=freqData[i*2]/255; eqGroup.children[i].scale.y=0.2+v*6; eqGroup.children[i].position.y=0.3+eqGroup.children[i].scale.y/2; } }
  controls.update(); renderer.render(scene,camera); labelRenderer.render(scene,camera); }
  animate();

  joinChannel(); addPeer($nick.value,$color.value);

  window.addEventListener('resize',()=>{ camera.aspect=window.innerWidth/window.innerHeight; camera.updateProjectionMatrix(); renderer.setSize(window.innerWidth,window.innerHeight); labelRenderer.setSize(window.innerWidth,window.innerHeight); });
  });
  </script>
</body>
</html>